This file explains how to run the program of the Peregrine cluster of the University of Groningen.

# Clone the repository

Enter the cluster. Navigate to where you want the repository to be. Then, type:

```{bash}
git clone https://github.com/rscherrer/ExplicitGenomeSpeciation
```

That will download the repository.

# Build the program

Assuming we are in the repository root (e.g. `cd ExplicitGenomeSpeciation`), build the target using:

```{bash}
./cluster/build_target.sh <path_to_target_folder>
```

If the target folder does not exist, it will be created. Otherwise, it will be overwritten. The target folder will contain the executable `EGS` as well as the necessary files to launch the simulations. All other files than the executable generated during the build (make files, object files) are stored into the `build` folder, within `cluster`.

# Update the protocol

Go to the target folder. A batch of simulations will be launched from here. Here, we consider that a batch of simulations is nothing more than an experiment aiming at exploring various parameter values, and that this experiment requires a protocol. The protocol defines what combinations of parameters are to be tested during the experiment. The target folder contains a file `protocol.txt` containing this information. The file should look something like this:

```
# This is a protocol file

#SBATCH --time=00:10:00

-mutation 0.001 0.01
-ecosel 0.1 0.2

```

All entries starting with `#SBATCH` are options to be written to the job file that will be passed to SLURM to launch the simulations. For more information about what SLURM options are available on Peregrine, please refer to the Peregrine wiki (https://redmine.hpc.rug.nl/redmine/projects/peregrine/wiki). All entries starting with a dash (e.g. `-mutation`) are interpreted as parameters to be tested. The dash should be immediately followed by a valid parameter name, and then by the values the parameter should take across simulations, separated by spaces. If several parameters with several values are provided, simulations will be launched for all combinations of values provided for these parameters. So, in the above example, simulations will be run for `mutation` = 0.001 -- `ecosel` = 0.1,
`mutation` = 0.001 -- `ecosel` = 0.2, `mutation` = 0.01 -- `ecosel` = 0.1 and `mutation` = 0.01 -- `ecosel` = 0.2. For parameters that take multiple values, such as `nvertices` that takes one value for each trait, please provide values of a single simulation separated by underscores. For example, `-nvertices 10_10_10 20_20_20` will launch simulations with 10 genes per trait as well as simulations with 20 genes per trait. Any line that does not start with `#SBATCH` or `-` will be ignored. Use a text editor (e.g. `nano` on the cluster) to make or edit a protocol file with the information needed to run your experiment. Parameters that are not mentioned in the protocol will take the values defined in the `parameters.txt` file, located in the target folder (a copy of it is in `cluster`). You can edit this file to set values to parameters that should be kept fixed across all simulations, thereby using the protocol only for parameters that should vary.

!!! Check that the run_simulation script can indeed add entries to the parameter file and not just replace them, important e.g. for the seed !!! 

# Launch the experiment

From within the target folder, run:

```{bash}
./run_experiment.sh protocol.txt
```

This creates as many folders as there are simulations to be run, inside the target folder. Every simulation folder contains a `job.sh` file and a `parameters.txt` file. All job files are submitted to SLURM in one go, and should start running on the server. Use `squeue -u $USER` to check the status and progression of your jobs. The naming convention for the simulation folders is `sim_parameter1_value1_parameter2_value2`, where `parameter1` and `parameter2` are the names of the parameters supplied in the protocol. For the example protocol above, the list of simulation folders should be:

```
sim_mutation_0.001_ecosel_0.1
sim_mutation_0.001_ecosel_0.2
sim_mutation_0.01_ecosel_0.1
sim_mutation_0.01_ecosel_0.2
```

All outputs to screen generated by a given simulation will be stored in a SLURM output file, with extension `.out`, in the simulation folder. You can visualize this file to diagnose the course of a simulation after it is done e.g. whether it went extinct, whether it ran at all or whether it completed succesfully.
